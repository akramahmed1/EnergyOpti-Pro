kfrom fastapi import FastAPI, Form, HTTPException, Header
from fastapi.staticfiles import StaticFiles
import tensorflow as tf
import numpy as np
from collections import deque
import logging

# Set up logging to console
logger = logging.getLogger("uvicorn.error")
logger.setLevel(logging.INFO)
handler = logging.StreamHandler()
formatter = logging.Formatter("%(asctime)s - %(levelname)s - %(message)s - v6")
handler.setFormatter(formatter)
logger.addHandler(handler)

app = FastAPI()
app.mount("/static", StaticFiles(directory="static"), name="static")
VALID_TOKEN = "a1009144b7a5520439407190f9064793"

interpreter = tf.lite.Interpreter(model_path="optimized_model.tflite")
interpreter.allocate_tensors()
input_details = interpreter.get_input_details()
output_details = interpreter.get_output_details()
history = deque(maxlen=5)

@app.get("/health")
async def health_check():
    logger.info("Health check requested")
    return {"status": "healthy"}

@app.get("/")
async def home():
    logger.info("Home page requested")
    return {"message": "Welcome to Energy Opti"}

@app.get("/static/index.html", include_in_schema=False)
async def serve_index():
    logger.info("Static index.html requested")
    return StaticFiles(directory="static").serve("index.html")

@app.post("/predict")
async def predict(value: float = Form(...), authorization: str = Header(None)):
    token = authorization.split(" ")[1] if authorization and authorization.startswith("Bearer ") else "unauth"
    if not authorization or not authorization.startswith("Bearer ") or token != VALID_TOKEN:
        logger.warning("Unauthorized access attempt")
        raise HTTPException(status_code=401, detail="Invalid token")
    try:
        logger.info(f"Predict request received with value={value}")
        input_data = np.array([[value]], dtype=np.float32)
        interpreter.set_tensor(input_details[0]['index'], input_data)
        interpreter.invoke()
        prediction = float(interpreter.get_tensor(output_details[0]['index'])[0][0])
        history.append((value, prediction))
        logger.info(f"Prediction successful: {prediction}, history={list(history)}")
        return {"prediction": prediction, "history": list(history)}
    except ValueError as ve:
        logger.error(f"ValueError: {ve}")
        return {"error": "Invali
